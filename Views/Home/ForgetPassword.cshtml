@model DemoWeb.Models.Employee

@{
    ViewData["Title"] = "Forget Password";
    Layout = "_LoginPage";
}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        // Initial form submission to check if the employee exists
        $('#btnForget').click(function (e) {
            e.preventDefault(); // Prevent default form submission

            // Get anti-forgery token
            var token = $("input[name='__RequestVerificationToken']").val();

            // Gather form data
            var forgetPasswordData = {
                _RequestVerificationToken: token,
                EmployeeEmail: $('#EmployeeEmail').val(),
              
           
            };

            console.log(forgetPasswordData);

            // Perform AJAX POST request to check employee existence
            $.ajax({
                type: 'POST',
                url: '@Url.Action("ForgetPassword", "Home")',
                data: forgetPasswordData,
                headers: {
                    'RequestVerificationToken': token
                }
            })
                .done(function (data) {
                    if (data.success) {
                         $('.modal-body').text(data.message);
                         $('#exampleModal').modal('show');
                        // Hide employee detail fields and show new password field
                        $('#employeeDetailsForm').hide();
                        $('#newPasswordForm').show();
                    } else {
                        $('.modal-body').text(data.message);
                        $('#exampleModal').modal('show');
                    }
                })
                .fail(function (err) {
                    $('.modal-body').text("An error occurred while checking employee details.");
                    $('#exampleModal').modal('show');
                    console.error(err);
                });
        });

        // Handle the form submission for new password
        $('#btnUpdatePassword').click(function (e) {
            e.preventDefault(); // Prevent default form submission

            // Get anti-forgery token
            var token = $("input[name='__RequestVerificationToken']").val();

            // Gather form data for updating the password
            var updatePasswordData = {
                _RequestVerificationToken: token,
                EmployeeEmail: $('#EmployeeEmail').val(),
                Password: $('#Password').val(),
                ConfirmPassword: $('#ConfirmPassword').val(),
            };

            // Perform AJAX POST request to update the password
            $.ajax({
                type: 'POST',
                url: '@Url.Action("UpdatePassword", "Home")',
                data: updatePasswordData,
                headers: {
                    'RequestVerificationToken': token
                }
            })
                .done(function (data) {
                    if (data.success) {
                        $('.modal-body').text(data.message);
                        $('#exampleModal').modal('show');
                        // Redirect to login page or any other page after updating
                        window.location.href = '@Url.Action("Login", "Home")';
                    } else {
                        $('.modal-body').text(data.message);
                        $('#exampleModal').modal('show');
                    }
                })
                .fail(function (err) {
                    $('.modal-body').text("An error occurred while updating the password.");
                    $('#exampleModal').modal('show');
                    console.error(err);
                });
        });
    });
</script>



<div class="wrapper">
    <div class="logo">
        <img src="~/image/homeLogo.png" alt="Logo">
    </div>
    <div class="text-center mt-4 name">
        Task Management System
    </div>

    <!-- First form to enter employee details -->
    <form id="employeeDetailsForm" class="p-3 mt-3">
         @Html.AntiForgeryToken()
        <!-- Email Field -->
        <div class="form-field d-flex align-items-center">
            <label asp-for="EmployeeEmail" class="sr-only"></label>
			<input asp-for="EmployeeEmail" class="form-control"  placeholder="Email">
			<span asp-validation-for="EmployeeEmail" class="text-danger"></span>
        </div>

        

        

        <!-- Submit Button -->
        <button type="button" class="btn mt-3" id="btnForget">Submit</button>
    </form>

    <!-- Hidden form for updating the password -->
    <form id="newPasswordForm" class="p-3 mt-3" style="display:none;">
         @Html.AntiForgeryToken()
        <!-- New Password Field -->
        <div class="form-field d-flex align-items-center mt-3">
           <label asp-for="Password" class="sr-only"></label>
			<input asp-for="Password" type="password" class="form-control" placeholder="Password">
			<span asp-validation-for="Password" class="text-danger"></span>
        </div>

        <div class="form-field d-flex align-items-center mt-3">
           <label asp-for="ConfirmPassword" class="sr-only"></label>
			<input asp-for="ConfirmPassword" type="password" class="form-control" placeholder="Confirm Password">
			<span asp-validation-for="ConfirmPassword" class="text-danger"></span>
        </div>

        <!-- Submit Button for updating the password -->
        <button type="button" class="btn mt-3" id="btnUpdatePassword">Update Password</button>
    </form>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}